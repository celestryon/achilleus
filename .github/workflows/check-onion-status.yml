name: Check Onion Status

on:
  schedule:
    # Run every 1 minute
    - cron: '*/1 * * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  check-onion:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install Tor
        run: |
          sudo apt-get update
          sudo apt-get install -y tor torsocks
      
      - name: Start Tor service
        run: |
          sudo service tor start
          sleep 10
          # Verify Tor is running
          sudo service tor status
      
      - name: Check .onion site status
        id: check-status
        run: |
          ONION_URL="banglaleaksxxxxxxxxxxxxxxxxxxxxxxxxxx.onion"
          
          # Try to connect to the .onion site with timeout
          if timeout 60 torsocks curl -s --max-time 45 "http://${ONION_URL}" > /dev/null 2>&1; then
            echo "online=true" >> $GITHUB_OUTPUT
            echo "✅ .onion site is ONLINE"
          else
            echo "online=false" >> $GITHUB_OUTPUT
            echo "❌ .onion site is OFFLINE"
          fi
      
      - name: Update status.json
        run: |
          ONLINE="${{ steps.check-status.outputs.online }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          echo "{
            \"online\": ${ONLINE},
            \"lastChecked\": \"${TIMESTAMP}\"
          }" > status.json
          
          cat status.json
      
      - name: Commit and push if changed
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add status.json
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update .onion status [automated]"
            git push
          fi
